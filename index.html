<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Sens Private - Secure Messenger</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        html, body, #root {
            height: 100%; height: 100dvh;
            margin: 0; padding: 0;
            overflow: hidden;
            background-color: #f8fafc;
            width: 100vw;
        }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .typing-dot {
            display: inline-block;
            width: 4px; height: 4px; border-radius: 50%;
            background-color: currentColor;
            animation: typingAnimation 1.4s infinite ease-in-out;
        }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typingAnimation {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
            30% { transform: translateY(-4px); opacity: 1; }
        }
        .message-group .reply-button { opacity: 0; transition: opacity 0.2s; }
        .message-group:hover .reply-button { opacity: 1; }
        @media (max-width: 768px) { .message-group .reply-button { opacity: 1; } }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        #localVideo { transform: scaleX(-1); border-radius: 1rem; }
        .fade-in { animation: fadeIn 0.2s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .msg-bubble { word-wrap: break-word; overflow-wrap: break-word; word-break: break-word; max-width: 100%; }
        .chat-input { max-height: 150px; min-height: 48px; resize: none; line-height: 1.5; }
    </style>
</head>
<body class="bg-slate-50 font-sans text-slate-900">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, doc, updateDoc, getDoc, setDoc, writeBatch, getDocs } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyACttfdN58V6wmpTbqRaHIgc_Swo5s4L-U",
            authDomain: "sens-1129c.firebaseapp.com",
            projectId: "sens-1129c",
            storageBucket: "sens-1129c.firebasestorage.app",
            messagingSenderId: "578023720878",
            appId: "1:578023720878:web:1f25be43855a6409f0aa3f"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const APP_ID = 'sens-chat';

        const USERS_PATH = ['artifacts', APP_ID, 'public', 'data', 'users'];
        const MSGS_PATH = ['artifacts', APP_ID, 'public', 'data', 'messages'];
        const CALLS_PATH = ['artifacts', APP_ID, 'public', 'data', 'calls'];

        const Icon = ({ name, className, size = 20 }) => {
            const iconRef = React.useRef(null);
            React.useEffect(() => {
                if (window.lucide && iconRef.current) {
                    const temp = document.createElement('div');
                    temp.innerHTML = `<i data-lucide="${name}"></i>`;
                    window.lucide.createIcons({ root: temp });
                    const svg = temp.querySelector('svg');
                    if (svg) {
                        svg.setAttribute('class', className || '');
                        svg.setAttribute('width', size);
                        svg.setAttribute('height', size);
                        iconRef.current.innerHTML = '';
                        iconRef.current.appendChild(svg);
                    }
                }
            }, [name, className, size]);
            return <span ref={iconRef} className="inline-flex items-center justify-center leading-none shrink-0" />;
        };

        function App() {
            const [user, setUser] = React.useState(null);
            const [profile, setProfile] = React.useState(null);
            const [globalMessages, setGlobalMessages] = React.useState([]); 
            const [allUsers, setAllUsers] = React.useState([]);
            const [selectedUser, setSelectedUser] = React.useState(null);
            const [newMessage, setNewMessage] = React.useState('');
            const [usernameInput, setUsernameInput] = React.useState('');
            const [passwordInput, setPasswordInput] = React.useState('');
            const [loading, setLoading] = React.useState(true);
            const [authError, setAuthError] = React.useState('');
            const [replyingTo, setReplyingTo] = React.useState(null);
            const [isAtBottom, setIsAtBottom] = React.useState(true);
            const [isCalling, setIsCalling] = React.useState(false);
            const [incomingCall, setIncomingCall] = React.useState(null);
            const [localStream, setLocalStream] = React.useState(null);
            const [remoteStream, setRemoteStream] = React.useState(null);
            const [isMuted, setIsMuted] = React.useState(false);
            const [isVideoOff, setIsVideoOff] = React.useState(false);
            
            const scrollRef = React.useRef(null);
            const inputRef = React.useRef(null);
            const pc = React.useRef(null);
            const lastSelectedId = React.useRef(null);
            const remoteVideoRef = React.useRef(null);

            const getChatId = (u1, u2) => {
                if (!u1 || !u2) return '';
                return [u1.toLowerCase(), u2.toLowerCase()].sort().join('_');
            };

            const formatTime = (ts) => {
                if (!ts) return '';
                const date = ts.toDate ? ts.toDate() : new Date(ts.seconds * 1000);
                if (isNaN(date.getTime())) return '';
                return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            };

            const getStatusText = (targetUser) => {
                if (!targetUser?.lastSeen) return 'Offline';
                const lastSeenDate = targetUser.lastSeen.toDate ? targetUser.lastSeen.toDate() : new Date(targetUser.lastSeen.seconds * 1000);
                const diffInSeconds = (new Date() - lastSeenDate) / 1000;
                return diffInSeconds < 40 ? 'Online' : `Last seen ${formatTime(targetUser.lastSeen)}`;
            };

            // Keyboard and UI Logic
            React.useEffect(() => {
                const handleKeyDown = (e) => { if (e.key === 'Escape') setSelectedUser(null); };
                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, []);

            React.useEffect(() => {
                if (replyingTo && inputRef.current) {
                    setTimeout(() => {
                        inputRef.current?.focus();
                    }, 50);
                }
            }, [replyingTo]);

            // Authentication
            React.useEffect(() => {
                signInAnonymously(auth);
                return onAuthStateChanged(auth, (u) => {
                    if (u) {
                        setUser(u);
                        onSnapshot(collection(db, ...USERS_PATH), (snapshot) => {
                            const found = snapshot.docs.find(d => d.data().uid === u.uid);
                            setProfile(found ? found.data() : { status: 'new' });
                            setLoading(false);
                        });
                    } else { setUser(null); setLoading(false); }
                });
            }, []);

            // Real-time Syncing
            React.useEffect(() => {
                if (!profile?.username || !user) return;
                const username = profile.username.toLowerCase();
                const updateStatus = () => { if (document.visibilityState === 'visible') updateDoc(doc(db, ...USERS_PATH, username), { lastSeen: serverTimestamp() }).catch(()=>{}); };
                const intv = setInterval(updateStatus, 15000);
                updateStatus();
                return () => clearInterval(intv);
            }, [profile?.username, user]);

            React.useEffect(() => {
                if (!user || (profile?.status !== 'approved' && profile?.role !== 'admin')) return;
                return onSnapshot(collection(db, ...USERS_PATH), (snapshot) => setAllUsers(snapshot.docs.map(d => ({ id: d.id, ...d.data() }))));
            }, [user, profile?.status]);

            React.useEffect(() => {
                const myName = profile?.username?.toLowerCase();
                if (!user || !myName) return;
                return onSnapshot(collection(db, ...MSGS_PATH), (snap) => {
                    setGlobalMessages(snap.docs.map(d => ({ id: d.id, ...d.data() })).filter(m => m.chatId?.toLowerCase().includes(myName)));
                });
            }, [user, profile?.username]);

            // Computed Values
            const currentMessages = React.useMemo(() => {
                if (!selectedUser || !profile?.username) return [];
                const chatId = getChatId(profile.username, selectedUser.username);
                return globalMessages.filter(m => m.chatId === chatId).sort((a,b) => (a.createdAt?.seconds||0) - (b.createdAt?.seconds||0)).slice(-100);
            }, [globalMessages, selectedUser?.username, profile?.username]);

            const unreadCountInSidebar = (partner) => {
                if (!profile?.username) return 0;
                const chatId = getChatId(profile.username, partner);
                return globalMessages.filter(m => m.chatId === chatId && m.senderName === partner && !m.read).length;
            };

            // Messaging Functions
            const handleSend = async (e) => {
                if (e) e.preventDefault();
                const text = newMessage.trim();
                if (!text || !user || !selectedUser || !profile?.username) return;
                
                const chatId = getChatId(profile.username, selectedUser.username);
                setNewMessage('');
                setReplyingTo(null);
                if (inputRef.current) inputRef.current.style.height = 'auto';

                try {
                    const msg = { 
                        text, 
                        senderName: profile.username, 
                        chatId, 
                        displayName: profile.username, 
                        createdAt: serverTimestamp(), 
                        read: false 
                    };
                    if (replyingTo) msg.replyTo = { text: replyingTo.text, displayName: replyingTo.displayName };
                    
                    await addDoc(collection(db, ...MSGS_PATH), msg);
                    updateDoc(doc(db, ...USERS_PATH, profile.username.toLowerCase()), { isTyping: false });
                } catch (err) {
                    console.error("Message failed", err);
                    setNewMessage(text); // Restore text on failure
                }
            };

            const toggleMic = () => { if (localStream) { localStream.getAudioTracks().forEach(t => t.enabled = isMuted); setIsMuted(!isMuted); } };
            const toggleVideo = () => { if (localStream) { localStream.getVideoTracks().forEach(t => t.enabled = isVideoOff); setIsVideoOff(!isVideoOff); } };

            // Scroll Logic
            React.useEffect(() => {
                if (!selectedUser) { lastSelectedId.current = null; return; }
                if (lastSelectedId.current !== selectedUser.username) {
                    scrollRef.current?.scrollIntoView({ behavior: 'auto' });
                    lastSelectedId.current = selectedUser.username;
                    setIsAtBottom(true);
                } else if (isAtBottom) {
                    scrollRef.current?.scrollIntoView({ behavior: 'smooth' });
                }
            }, [currentMessages, selectedUser]);

            // Read Status Logic
            React.useEffect(() => {
                if (!user || !selectedUser || currentMessages.length === 0 || !profile?.username) return;
                if (document.visibilityState === 'visible' && document.hasFocus() && isAtBottom) {
                    currentMessages.filter(m => m.senderName === selectedUser.username && !m.read).forEach(m => {
                        updateDoc(doc(db, ...MSGS_PATH, m.id), { read: true }).catch(()=>{});
                    });
                }
            }, [currentMessages, selectedUser?.username, isAtBottom, profile?.username]);

            if (loading) return <div className="h-screen flex items-center justify-center bg-slate-50"><div className="animate-spin h-8 w-8 border-4 border-indigo-600 border-t-transparent rounded-full"></div></div>;

            if (!user || profile?.status === 'new') return (
                <div className="h-screen flex items-center justify-center p-4 bg-slate-100">
                    <div className="bg-white p-8 rounded-3xl shadow-xl max-w-sm w-full border text-center">
                        <Icon name="shield" size={48} className="mx-auto mb-4 text-indigo-600" />
                        <h2 className="text-2xl font-bold mb-6">Sens Vault</h2>
                        <form onSubmit={async (e) => {
                            e.preventDefault();
                            setLoading(true);
                            const uRef = doc(db, ...USERS_PATH, usernameInput.trim().toLowerCase());
                            const uDoc = await getDoc(uRef);
                            if (uDoc.exists()) {
                                if (uDoc.data().password === passwordInput) await updateDoc(uRef, { uid: user.uid, lastSeen: serverTimestamp() });
                                else setAuthError('Invalid Access Key');
                            } else {
                                await setDoc(uRef, { username: usernameInput.trim(), password: passwordInput, status: 'pending', createdAt: serverTimestamp(), role: 'member', uid: user.uid, isTyping: false, lastSeen: serverTimestamp() });
                            }
                            setLoading(false);
                        }} className="space-y-4 text-left">
                            <input className="w-full border p-4 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Username" value={usernameInput} onChange={e => setUsernameInput(e.target.value)} required />
                            <input type="password" className="w-full border p-4 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Access Key" value={passwordInput} onChange={e => setPasswordInput(e.target.value)} required />
                            {authError && <p className="text-red-500 text-xs font-bold">{authError}</p>}
                            <button className="w-full bg-indigo-600 text-white font-bold py-4 rounded-xl">Initialize</button>
                        </form>
                    </div>
                </div>
            );

            if (profile?.status === 'pending') return <div className="h-screen flex items-center justify-center p-4 text-center bg-slate-50"><div className="max-w-xs"><Icon name="clock" size={48} className="mx-auto mb-4 text-amber-500 animate-pulse" /><h2 className="text-xl font-bold uppercase tracking-widest">Auth Pending</h2><p className="text-slate-500 text-xs mt-2">Waiting for admin approval for @{profile.username}</p></div></div>;

            return (
                <div className="flex h-screen w-full max-w-6xl mx-auto bg-white relative overflow-hidden md:flex-row border-x border-slate-100">
                    {/* Sidebar */}
                    <div className={`w-full md:w-80 border-r bg-slate-50 flex flex-col shrink-0 h-full ${selectedUser ? 'hidden md:flex' : 'flex'}`}>
                        <header className="p-4 md:p-5 bg-indigo-900 text-white flex items-center justify-between shrink-0 h-16 shadow-lg z-20">
                            <div className="flex items-center gap-2"><Icon name="message-square" className="text-indigo-300" /><h2 className="font-bold text-sm tracking-widest uppercase">Secure</h2></div>
                            <button onClick={() => updateDoc(doc(db, ...USERS_PATH, profile.username.toLowerCase()), { uid: null }).then(() => window.location.reload())}><Icon name="log-out" size={18} /></button>
                        </header>
                        <div className="flex-1 overflow-y-auto hide-scrollbar">
                            <div className="px-3 py-4 text-[10px] font-black uppercase text-slate-400 tracking-widest">Active Channels</div>
                            {allUsers.filter(u => u.status === 'approved' && (profile.role === 'admin' ? u.role !== 'admin' : u.role === 'admin')).map(u => {
                                const chatId = getChatId(profile.username, u.username);
                                const chatHistory = globalMessages.filter(m => m.chatId === chatId);
                                const lastM = chatHistory.sort((a,b) => (b.createdAt?.seconds||0) - (a.createdAt?.seconds||0))[0];
                                const unread = unreadCountInSidebar(u.username);
                                return (
                                    <button key={u.id} onClick={() => setSelectedUser(u)} className={`w-full text-left p-4 transition-all flex items-center gap-3 border-b ${selectedUser?.username === u.username ? 'bg-indigo-600 text-white shadow-xl' : 'bg-white hover:bg-slate-50'}`}>
                                        <div className="relative shrink-0">
                                            <div className={`w-12 h-12 rounded-full flex items-center justify-center font-bold uppercase text-lg ${selectedUser?.username === u.username ? 'bg-indigo-500' : 'bg-indigo-100 text-indigo-600'}`}>{u.username[0]}</div>
                                            {getStatusText(u) === 'Online' && <div className="absolute bottom-0.5 right-0.5 w-3.5 h-3.5 bg-green-500 border-2 border-white rounded-full"></div>}
                                        </div>
                                        <div className="flex flex-col min-w-0 flex-1">
                                            <div className="flex justify-between items-baseline mb-0.5">
                                                <span className="font-bold text-[15px] uppercase truncate pr-2">@{u.username}</span>
                                                {lastM && <span className={`text-[9px] ${selectedUser?.username === u.username ? 'text-indigo-200' : 'text-slate-400'}`}>{formatTime(lastM.createdAt)}</span>}
                                            </div>
                                            <div className="flex justify-between items-center min-w-0">
                                                <p className={`text-[13px] truncate flex-1 ${selectedUser?.username === u.username ? 'text-indigo-100' : 'text-slate-500'}`}>{u.isTyping ? 'typing...' : (lastM ? lastM.text : 'No history')}</p>
                                                {unread > 0 && selectedUser?.username !== u.username && <div className="bg-indigo-600 text-white text-[10px] font-black min-w-[18px] h-5 rounded-full flex items-center justify-center shadow-lg ml-2 animate-bounce">{unread}</div>}
                                            </div>
                                        </div>
                                    </button>
                                );
                            })}
                        </div>
                    </div>

                    {/* Chat Area */}
                    <div className={`flex-1 flex flex-col bg-white relative h-full min-w-0 ${selectedUser ? 'flex' : 'hidden md:flex'}`}>
                        {selectedUser ? (
                            <>
                                <header className="p-3 md:p-4 border-b flex justify-between items-center bg-white shrink-0 h-16 z-10 shadow-sm">
                                    <div className="flex items-center gap-2 min-w-0">
                                        <button onClick={() => setSelectedUser(null)} className="md:hidden p-1 text-slate-400"><Icon name="chevron-left" size={24} /></button>
                                        <div className="w-10 h-10 rounded-full bg-slate-50 border flex items-center justify-center font-bold uppercase text-indigo-600 shrink-0">{(selectedUser.username || "U")[0]}</div>
                                        <div className="flex flex-col min-w-0">
                                            <h2 className="font-black text-sm tracking-tighter truncate uppercase">@{selectedUser.username}</h2>
                                            <div className="flex items-center gap-1">
                                                <div className={`w-1.5 h-1.5 rounded-full ${getStatusText(selectedUser) === 'Online' ? 'bg-green-500 animate-pulse' : 'bg-slate-300'}`}></div>
                                                <span className="text-[9px] font-bold text-indigo-500 uppercase tracking-widest">{getStatusText(selectedUser)}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div className="flex gap-2">
                                        <button title="Video Call" className="p-2 text-indigo-600 hover:bg-indigo-50 rounded-xl"><Icon name="video" size={20} /></button>
                                        <button onClick={async () => {
                                            const chatId = getChatId(profile.username, selectedUser.username);
                                            const snap = await getDocs(collection(db, ...MSGS_PATH));
                                            const batch = writeBatch(db);
                                            snap.forEach(d => { if(d.data().chatId === chatId) batch.delete(d.ref); });
                                            await batch.commit();
                                        }} className="p-2 text-slate-300 hover:text-red-500"><Icon name="trash-2" size={20} /></button>
                                    </div>
                                </header>

                                <main onScroll={(e) => setIsAtBottom(e.target.scrollHeight - e.target.scrollTop - e.target.clientHeight < 100)} className="flex-1 overflow-y-auto p-4 space-y-5 bg-slate-50/30 hide-scrollbar relative">
                                    {currentMessages.map(m => {
                                        const isMine = m.senderName === profile.username;
                                        return (
                                            <div key={m.id} className={`flex ${isMine ? 'justify-end' : 'justify-start'} group items-center gap-2 message-group`}>
                                                <button onClick={() => setReplyingTo(m)} className={`reply-button p-2 text-slate-400 bg-white border border-slate-100 rounded-full shadow-sm shrink-0 active:scale-90 ${isMine ? 'order-first' : 'order-last'}`}><Icon name="corner-up-left" size={12} /></button>
                                                <div className={`flex flex-col min-w-0 ${isMine ? 'items-end' : 'items-start'} max-w-[85%] md:max-w-[75%]`}>
                                                    <div className={`p-4 rounded-2xl text-[14px] shadow-sm relative msg-bubble ${isMine ? 'bg-indigo-600 text-white rounded-tr-none' : 'bg-white border text-slate-800 rounded-tl-none'}`}>
                                                        {m.replyTo && <div className={`mb-2 p-2 text-[10px] rounded-lg border-l-4 font-bold ${isMine ? 'bg-indigo-700/50 border-indigo-300' : 'bg-slate-100 border-indigo-500 text-slate-500'} italic truncate`}>Replied: {m.replyTo.text}</div>}
                                                        <div className="break-words">{m.text}</div>
                                                    </div>
                                                    <div className="flex items-center gap-1.5 mt-1.5 px-2">
                                                        <span className="text-[9px] text-slate-400 font-medium">{formatTime(m.createdAt)}</span>
                                                        {isMine && <><span className={`text-[9px] font-black uppercase tracking-widest ${m.read ? 'text-indigo-500' : 'text-slate-300'}`}>{m.read ? 'Opened' : 'Sent'}</span><Icon name={m.read ? "check-check" : "check"} size={10} className={m.read ? "text-indigo-500" : "text-slate-300"} /></>}
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                    <div ref={scrollRef} className="h-4" />
                                </main>

                                {unreadCount > 0 && <button onClick={() => scrollRef.current?.scrollIntoView({behavior:'smooth'})} className="absolute bottom-24 right-4 bg-indigo-600 text-white px-4 py-2 rounded-full shadow-2xl flex items-center gap-2 animate-bounce z-50 border-2 border-white"><Icon name="arrow-down" size={14} /><span className="text-[11px] font-black uppercase tracking-widest">{unreadCount} New</span></button>}

                                <footer className="p-3 md:p-4 border-t bg-white relative pb-safe shrink-0">
                                    {replyingTo && (
                                        <div className="mb-3 p-3 bg-indigo-50 border-l-4 border-indigo-600 rounded-xl flex items-center justify-between shadow-inner">
                                            <div className="flex-1 truncate pr-4 text-[10px] font-bold text-slate-600"><span className="text-indigo-600 block text-[9px] mb-0.5 uppercase font-black">Replying to {replyingTo.displayName}</span>{replyingTo.text}</div>
                                            <button onClick={() => setReplyingTo(null)} className="p-1"><Icon name="x" size={16} /></button>
                                        </div>
                                    )}
                                    <form onSubmit={handleSend} className="flex gap-2 w-full items-end">
                                        <button type="button" className="p-3 shrink-0 text-slate-400"><Icon name="smile" size={24} /></button>
                                        <textarea ref={inputRef} value={newMessage} onFocus={() => setReplyingTo(null)} onKeyDown={(e) => { if(e.key==='Enter' && !e.shiftKey) { e.preventDefault(); handleSend(); } }} onChange={handleInputChange} className="flex-1 bg-slate-50 border border-slate-200 rounded-2xl px-4 py-3 outline-none focus:ring-4 focus:ring-indigo-500/10 text-base min-w-0 chat-input overflow-y-auto hide-scrollbar" placeholder="Message..." rows="1" />
                                        <button type="submit" disabled={!newMessage.trim()} className="bg-indigo-600 text-white p-3 md:p-4 rounded-2xl shadow-xl hover:bg-indigo-700 active:scale-90 disabled:opacity-50 shrink-0 mb-1"><Icon name="send" size={20} /></button>
                                    </form>
                                </footer>
                            </>
                        ) : (
                            <div className="flex-1 flex flex-col items-center justify-center text-slate-300 p-8 text-center uppercase tracking-[0.25em] font-black">
                                <div className="bg-slate-50 p-10 rounded-[3rem] border border-slate-100 mb-8"><Icon name="message-square" size={64} className="opacity-10" /></div>
                                <p className="text-[10px]">Vault Secured</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        }
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
