import React, { useState, useEffect, useRef, useMemo } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getFirestore, 
  collection, 
  query, 
  onSnapshot, 
  addDoc, 
  serverTimestamp, 
  doc, 
  updateDoc, 
  getDoc, 
  setDoc,
  deleteDoc,
  getDocs,
  writeBatch
} from 'firebase/firestore';
import { 
  getAuth, 
  signInAnonymously, 
  onAuthStateChanged,
  signInWithCustomToken 
} from 'firebase/auth';
import { 
  Send, 
  User, 
  MessageSquare, 
  Shield, 
  Clock, 
  LogOut, 
  Video, 
  VideoOff, 
  Mic, 
  MicOff, 
  Phone, 
  PhoneOff, 
  CornerUpLeft, 
  X,
  Check,
  CheckCheck,
  Smile,
  ArrowDown
} from 'lucide-react';

// --- FIREBASE CONFIGURATION ---
const firebaseConfig = {
    apiKey: "AIzaSyACttfdN58V6wmpTbqRaHIgc_Swo5s4L-U",
    authDomain: "sens-1129c.firebaseapp.com",
    projectId: "sens-1129c",
    storageBucket: "sens-1129c.firebasestorage.app",
    messagingSenderId: "578023720878",
    appId: "1:578023720878:web:1f25be43855a6409f0aa3f"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const APP_ID = 'sens-chat';

const USERS_PATH = ['artifacts', APP_ID, 'public', 'data', 'users'];
const MSGS_PATH = ['artifacts', APP_ID, 'public', 'data', 'messages'];
const CALLS_PATH = ['artifacts', APP_ID, 'public', 'data', 'calls'];

export default function App() {
  const [user, setUser] = useState(null);
  const [profile, setProfile] = useState(null);
  const [globalMessages, setGlobalMessages] = useState([]);
  const [allUsers, setAllUsers] = useState([]);
  const [selectedUser, setSelectedUser] = useState(null);
  const [newMessage, setNewMessage] = useState('');
  const [usernameInput, setUsernameInput] = useState('');
  const [passwordInput, setPasswordInput] = useState('');
  const [loading, setLoading] = useState(true);
  const [authError, setAuthError] = useState('');
  const [replyingTo, setReplyingTo] = useState(null);
  const [isAtBottom, setIsAtBottom] = useState(true);

  // Video Call States
  const [isCalling, setIsCalling] = useState(false);
  const [incomingCall, setIncomingCall] = useState(null);
  const [localStream, setLocalStream] = useState(null);
  const [remoteStream, setRemoteStream] = useState(null);
  const [isMuted, setIsMuted] = useState(false);
  const [isVideoOff, setIsVideoOff] = useState(false);

  const scrollRef = useRef(null);
  const inputRef = useRef(null);
  const pc = useRef(null);
  const lastSelectedId = useRef(null);

  const getChatId = (u1, u2) => [u1.toLowerCase(), u2.toLowerCase()].sort().join('_');

  const formatTime = (ts) => {
    if (!ts) return '';
    const date = ts.toDate ? ts.toDate() : new Date(ts.seconds * 1000);
    return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  };

  const getStatusText = (targetUser) => {
    if (!targetUser?.lastSeen) return 'Offline';
    const lastSeenDate = targetUser.lastSeen.toDate ? targetUser.lastSeen.toDate() : new Date(targetUser.lastSeen.seconds * 1000);
    const now = new Date();
    const diffInSeconds = (now - lastSeenDate) / 1000;
    if (diffInSeconds < 40) return 'Online';
    return `Last seen ${formatTime(targetUser.lastSeen)}`;
  };

  // 1. Auth & Presence Sync
  useEffect(() => {
    const initAuth = async () => {
        try { await signInAnonymously(auth); } catch (e) { console.error(e); }
    };
    initAuth();

    return onAuthStateChanged(auth, (u) => {
      if (u) {
        setUser(u);
        const unsubscribe = onSnapshot(collection(db, ...USERS_PATH), (snapshot) => {
          const found = snapshot.docs.find(d => d.data().uid === u.uid);
          if (found) setProfile(found.data());
          else setProfile({ status: 'new' });
          setLoading(false);
        });
        return unsubscribe;
      } else { setUser(null); setProfile(null); setLoading(false); }
    });
  }, []);

  // 2. Presence Update
  useEffect(() => {
    if (!profile?.username || !user) return;
    const updateStatus = () => {
      if (document.visibilityState === 'visible') {
        updateDoc(doc(db, ...USERS_PATH, profile.username.toLowerCase()), { lastSeen: serverTimestamp() }).catch(()=>{});
      }
    };
    updateStatus();
    const intv = setInterval(updateStatus, 15000);
    window.addEventListener('focus', updateStatus);
    return () => { clearInterval(intv); window.removeEventListener('focus', updateStatus); };
  }, [profile?.username, user]);

  // 3. User & Message Listeners
  useEffect(() => {
    if (!user || (profile?.status !== 'approved' && profile?.role !== 'admin')) return;
    return onSnapshot(collection(db, ...USERS_PATH), (snapshot) => {
      setAllUsers(snapshot.docs.map(d => ({ id: d.id, ...d.data() })));
    });
  }, [user, profile]);

  useEffect(() => {
    if (!user || !profile?.username) return;
    return onSnapshot(collection(db, ...MSGS_PATH), (snapshot) => {
      const all = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      setGlobalMessages(all.filter(m => m.chatId && m.chatId.toLowerCase().includes(profile.username.toLowerCase())));
    });
  }, [user, profile?.username]);

  // 4. Derived Data
  const currentMessages = useMemo(() => {
    if (!selectedUser || !profile?.username) return [];
    const chatId = getChatId(profile.username, selectedUser.username);
    return globalMessages
        .filter(m => m.chatId === chatId)
        .sort((a, b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0))
        .slice(-100);
  }, [globalMessages, selectedUser, profile?.username]);

  const unreadCount = useMemo(() => {
    if (!selectedUser || isAtBottom) return 0;
    return currentMessages.filter(m => m.senderName === selectedUser.username && !m.read).length;
  }, [currentMessages, selectedUser, isAtBottom]);

  // 5. Scroll & Read Status Logic
  useEffect(() => {
    if (!selectedUser) { lastSelectedId.current = null; return; }
    if (lastSelectedId.current !== selectedUser.username) {
        scrollRef.current?.scrollIntoView({ behavior: 'auto' });
        lastSelectedId.current = selectedUser.username;
        setIsAtBottom(true);
    } else if (isAtBottom) {
        scrollRef.current?.scrollIntoView({ behavior: 'smooth' });
    }
  }, [currentMessages, selectedUser]);

  useEffect(() => {
    if (!user || !selectedUser || currentMessages.length === 0 || !profile?.username) return;
    if (document.visibilityState === 'visible' && document.hasFocus() && isAtBottom) {
      currentMessages.filter(m => m.senderName === selectedUser.username && !m.read).forEach(m => {
        updateDoc(doc(db, ...MSGS_PATH, m.id), { read: true }).catch(()=>{});
      });
    }
  }, [currentMessages, selectedUser, isAtBottom, profile]);

  // 6. FOCUS FIX: When replyingTo state changes, trigger cursor focus
  useEffect(() => {
    if (replyingTo && inputRef.current) {
        // Use a short timeout to ensure the DOM has rendered the reply banner
        setTimeout(() => {
            inputRef.current?.focus();
        }, 50);
    }
  }, [replyingTo]);

  const handleReply = (message) => {
    setReplyingTo(message);
    // Focus immediately in the click handler for better mobile support
    if (inputRef.current) {
        inputRef.current.focus();
    }
  };

  // --- HANDLERS ---
  const handleLogin = async (e) => {
    e.preventDefault();
    const cleanU = usernameInput.trim().toLowerCase();
    const pass = passwordInput.trim();
    if (!cleanU || !pass) return;
    setLoading(true);
    try {
      const userRef = doc(db, ...USERS_PATH, cleanU);
      const userDoc = await getDoc(userRef);
      if (userDoc.exists()) {
        if (userDoc.data().password === pass) await updateDoc(userRef, { uid: user.uid, lastSeen: serverTimestamp() });
        else setAuthError('Incorrect access key.');
      } else {
        await setDoc(userRef, { username: usernameInput.trim(), password: pass, status: 'pending', createdAt: serverTimestamp(), role: 'member', uid: user.uid, isTyping: false, lastSeen: serverTimestamp() });
      }
    } catch (err) { setAuthError('Vault connection failed.'); }
    setLoading(false);
  };

  const handleSend = async (e) => {
    if (e) e.preventDefault();
    if (!newMessage.trim() || !user || !selectedUser) return;
    const text = newMessage; setNewMessage(''); setReplyingTo(null);
    if (inputRef.current) inputRef.current.style.height = 'auto';
    try {
      const msg = { text, senderName: profile.username, chatId: getChatId(profile.username, selectedUser.username), displayName: profile.username, createdAt: serverTimestamp(), read: false };
      if (replyingTo) msg.replyTo = { text: replyingTo.text, displayName: replyingTo.displayName };
      await addDoc(collection(db, ...MSGS_PATH), msg);
      updateDoc(doc(db, ...USERS_PATH, profile.username.toLowerCase()), { isTyping: false });
    } catch (e) { setNewMessage(text); }
  };

  const toggleMic = () => { if(localStream) { localStream.getAudioTracks().forEach(t => t.enabled = isMuted); setIsMuted(!isMuted); }};
  const toggleVideo = () => { if(localStream) { localStream.getVideoTracks().forEach(t => t.enabled = isVideoOff); setIsVideoOff(!isVideoOff); }};

  if (loading) return <div className="h-screen flex items-center justify-center bg-slate-50"><div className="animate-spin h-8 w-8 border-4 border-indigo-600 border-t-transparent rounded-full"></div></div>;

  if (!user || profile?.status === 'new') return (
    <div className="h-screen flex items-center justify-center p-4 bg-slate-100 font-sans">
      <div className="bg-white p-8 rounded-3xl shadow-xl max-w-sm w-full border border-slate-200 text-center">
        <Shield size={48} className="mx-auto mb-4 text-indigo-600" />
        <h2 className="text-2xl font-bold mb-6 uppercase tracking-tight">Sens Vault</h2>
        <form onSubmit={handleLogin} className="space-y-4 text-left">
          <input className="w-full bg-slate-50 border p-4 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Username" value={usernameInput} onChange={e => setUsernameInput(e.target.value)} required />
          <input type="password" className="w-full bg-slate-50 border p-4 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Access Key" value={passwordInput} onChange={e => setPasswordInput(e.target.value)} required />
          {authError && <p className="text-red-500 text-xs font-bold">{authError}</p>}
          <button className="w-full bg-indigo-600 text-white font-bold py-4 rounded-xl active:scale-95 transition-transform">Connect</button>
        </form>
      </div>
    </div>
  );

  if (profile?.status === 'pending') return <div className="h-screen flex items-center justify-center p-4 text-center bg-slate-50"><div className="max-w-xs"><Clock size={48} className="mx-auto mb-4 text-amber-500 animate-pulse" /><h2 className="text-xl font-bold">Access Pending</h2><p className="text-slate-500 text-sm mt-2">Wait for admin verification for @{profile.username}.</p></div></div>;

  return (
    <div className="flex h-screen w-full max-w-6xl mx-auto bg-white relative overflow-hidden md:flex-row border-x border-slate-100 font-sans">
      {/* Sidebar */}
      <div className={`w-full md:w-80 border-r bg-slate-50 flex flex-col shrink-0 h-full ${selectedUser ? 'hidden md:flex' : 'flex'}`}>
        <header className="p-5 bg-indigo-900 text-white flex items-center justify-between shrink-0 h-16">
          <div className="flex items-center gap-2"><MessageSquare size={20} className="text-indigo-300" /><h2 className="font-bold text-sm tracking-widest uppercase">Secure</h2></div>
          <button onClick={() => updateDoc(doc(db, ...USERS_PATH, profile.username.toLowerCase()), { uid: null }).then(() => setUser(null))} className="p-2"><LogOut size={18} /></button>
        </header>
        <div className="flex-1 overflow-y-auto hide-scrollbar">
          {profile?.role === 'admin' && (
             <div className="p-2 space-y-1">
                <div className="px-3 py-2 text-[10px] font-black uppercase text-slate-400">Queue</div>
                {allUsers.filter(u => u.status === 'pending').map(u => (
                    <div key={u.id} className="p-3 bg-white border rounded-xl mb-2"><p className="font-bold text-sm mb-2 uppercase">@{u.username}</p><button onClick={() => updateDoc(doc(db, ...USERS_PATH, u.username.toLowerCase()), {status:'approved'})} className="w-full bg-indigo-600 text-white py-2 rounded-lg text-[10px] font-bold">APPROVE</button></div>
                ))}
             </div>
          )}
          <div className="px-3 py-4 text-[10px] font-black uppercase text-slate-400 tracking-widest">Channels</div>
          {allUsers.filter(u => u.status === 'approved' && (profile.role === 'admin' ? u.role !== 'admin' : u.role === 'admin')).map(u => {
             const chatId = getChatId(profile.username, u.username);
             const chatMsgs = globalMessages.filter(m => m.chatId === chatId);
             const lastM = chatMsgs.sort((a,b) => (b.createdAt?.seconds||0) - (a.createdAt?.seconds||0))[0];
             const unread = globalMessages.filter(m => m.chatId === chatId && m.senderName === u.username && !m.read).length;
             const status = getStatusText(u);
             return (
               <button key={u.id} onClick={() => setSelectedUser(u)} className={`w-full text-left p-4 transition-all flex items-center gap-3 border-b border-slate-100 ${selectedUser?.username === u.username ? 'bg-indigo-600 text-white shadow-xl' : 'bg-white hover:bg-slate-50'}`}>
                  <div className="relative shrink-0">
                    <div className={`w-12 h-12 rounded-full flex items-center justify-center font-bold uppercase text-lg ${selectedUser?.username === u.username ? 'bg-indigo-500' : 'bg-indigo-100 text-indigo-600'}`}>{u.username[0]}</div>
                    {status === 'Online' && <div className="absolute bottom-0.5 right-0.5 w-3.5 h-3.5 bg-green-500 border-2 border-white rounded-full"></div>}
                  </div>
                  <div className="flex flex-col min-w-0 flex-1">
                    <div className="flex justify-between items-baseline mb-0.5">
                      <span className="font-bold text-[15px] uppercase truncate pr-2">@{u.username}</span>
                      {lastM && <span className="text-[9px] opacity-60 shrink-0">{formatTime(lastM.createdAt)}</span>}
                    </div>
                    <div className="flex justify-between items-center min-w-0">
                      <p className="text-[13px] truncate opacity-70 flex-1">{u.isTyping ? 'typing...' : (lastM ? lastM.text : 'No messages')}</p>
                      {unread > 0 && selectedUser?.username !== u.username && <div className="bg-indigo-600 text-white text-[10px] font-black min-w-[18px] h-5 rounded-full flex items-center justify-center shadow-lg ml-2">{unread}</div>}
                    </div>
                  </div>
               </button>
             );
          })}
        </div>
      </div>

      {/* Chat Area */}
      <div className={`flex-1 flex flex-col bg-white relative h-full min-w-0 ${selectedUser ? 'flex' : 'hidden md:flex'}`}>
        {selectedUser ? (
          <>
            <header className="p-3 md:p-4 border-b flex justify-between items-center bg-white shrink-0 h-16 z-10 shadow-sm">
              <div className="flex items-center gap-2 min-w-0">
                <button onClick={() => setSelectedUser(null)} className="md:hidden p-1 text-slate-400"><X size={20} /></button>
                <div className="w-10 h-10 rounded-full bg-slate-50 border flex items-center justify-center font-bold uppercase text-indigo-600 shrink-0">{(selectedUser.username || "U")[0]}</div>
                <div className="flex flex-col min-w-0">
                  <h2 className="font-black text-sm tracking-tighter truncate uppercase">@{selectedUser.username}</h2>
                  <div className="flex items-center gap-1">
                    <div className={`w-1.5 h-1.5 rounded-full ${getStatusText(selectedUser) === 'Online' ? 'bg-green-500 animate-pulse' : 'bg-slate-300'}`}></div>
                    <span className="text-[9px] font-bold text-indigo-500 uppercase tracking-widest">{getStatusText(selectedUser)}</span>
                  </div>
                </div>
              </div>
              <div className="flex gap-2">
                 <button className="p-2 text-indigo-600 hover:bg-indigo-50 rounded-xl"><Video size={20} /></button>
                 <button onClick={() => {
                    const chatId = getChatId(profile.username, selectedUser.username);
                    getDocs(collection(db, ...MSGS_PATH)).then(snap => {
                        const batch = writeBatch(db);
                        snap.forEach(d => { if(d.data().chatId === chatId) batch.delete(d.ref); });
                        batch.commit();
                    });
                 }} className="p-2 text-slate-300 hover:text-red-500"><PhoneOff size={18} /></button>
              </div>
            </header>

            <main onScroll={(e) => setIsAtBottom(e.target.scrollHeight - e.target.scrollTop - e.target.clientHeight < 100)} className="flex-1 overflow-y-auto p-4 space-y-5 bg-slate-50/30 hide-scrollbar relative">
              {currentMessages.map(m => {
                const isMine = m.senderName === profile.username;
                return (
                  <div key={m.id} className={`flex ${isMine ? 'justify-end' : 'justify-start'} group items-center gap-2 message-group`}>
                    <button onClick={() => handleReply(m)} className={`reply-button p-2 text-slate-400 bg-white border border-slate-100 rounded-full shadow-sm shrink-0 active:scale-90 ${isMine ? 'order-first' : 'order-last'}`}><CornerUpLeft size={12} /></button>
                    <div className={`flex flex-col min-w-0 ${isMine ? 'items-end' : 'items-start'} max-w-[85%] md:max-w-[75%]`}>
                      <div className={`p-4 rounded-2xl text-[14px] leading-relaxed shadow-sm relative msg-bubble ${isMine ? 'bg-indigo-600 text-white rounded-tr-none' : 'bg-white border border-slate-200 text-slate-800 rounded-tl-none'}`}>
                        {m.replyTo && <div className={`mb-2 p-2 text-[10px] rounded-lg border-l-4 font-bold ${isMine ? 'bg-indigo-700/50 border-indigo-300' : 'bg-slate-100 border-indigo-500 text-slate-500'} italic truncate`}>Replied: {m.replyTo.text}</div>}
                        <div className="break-words">{m.text}</div>
                      </div>
                      <div className="flex items-center gap-1.5 mt-1.5 px-2">
                        <span className="text-[9px] text-slate-400 font-medium">{formatTime(m.createdAt)}</span>
                        {isMine && <><span className={`text-[9px] font-black uppercase tracking-widest ${m.read ? 'text-indigo-500' : 'text-slate-300'}`}>{m.read ? 'Opened' : 'Sent'}</span>{m.read ? <CheckCheck size={10} className="text-indigo-500" /> : <Check size={10} className="text-slate-300" />}</>}
                      </div>
                    </div>
                  </div>
                );
              })}
              {selectedUser.isTyping && <div className="flex justify-start"><div className="bg-white border p-3 rounded-2xl flex items-center gap-2 text-slate-400 text-xs font-bold uppercase italic shadow-sm">typing <div className="flex gap-0.5"><span className="typing-dot"></span><span className="typing-dot"></span><span className="typing-dot"></span></div></div></div>}
              <div ref={scrollRef} className="h-4" />
            </main>

            {unreadCount > 0 && (
                <button onClick={() => scrollRef.current?.scrollIntoView({behavior:'smooth'})} className="absolute bottom-24 right-4 bg-indigo-600 text-white px-4 py-2 rounded-full shadow-2xl flex items-center gap-2 animate-bounce z-50 border-2 border-white">
                    <ArrowDown size={14} /><span className="text-[11px] font-black uppercase tracking-widest">{unreadCount} New</span>
                </button>
            )}

            <footer className="p-3 md:p-4 border-t bg-white relative pb-safe shrink-0">
              {replyingTo && (
                <div className="mb-3 p-3 bg-indigo-50 border-l-4 border-indigo-600 rounded-xl flex items-center justify-between shadow-inner animate-in slide-in-from-bottom-2">
                  <div className="flex-1 truncate pr-4 text-[10px] font-bold text-slate-600"><span className="text-indigo-600 block text-[9px] mb-0.5 uppercase font-black">Replying to {replyingTo.displayName}</span>{replyingTo.text}</div>
                  <button onClick={() => setReplyingTo(null)} className="text-slate-400 p-1"><X size={16} /></button>
                </div>
              )}
              <form onSubmit={handleSend} className="flex gap-2 w-full items-end">
                <button type="button" className="p-3 shrink-0 text-slate-400"><Smile size={24} /></button>
                <textarea 
                  ref={inputRef}
                  value={newMessage} 
                  onKeyDown={(e) => { if(e.key==='Enter' && !e.shiftKey) { e.preventDefault(); handleSend(); } }}
                  onChange={(e) => { 
                    setNewMessage(e.target.value); 
                    e.target.style.height = 'auto'; e.target.style.height = `${e.target.scrollHeight}px`; 
                    updateDoc(doc(db, ...USERS_PATH, profile.username.toLowerCase()), { isTyping: e.target.value.length > 0 });
                  }} 
                  className="flex-1 bg-slate-50 border border-slate-200 rounded-2xl px-4 py-3 outline-none focus:ring-4 focus:ring-indigo-500/10 text-base min-w-0 chat-input overflow-y-auto hide-scrollbar" 
                  placeholder="Message..." 
                  rows="1"
                />
                <button type="submit" disabled={!newMessage.trim()} className="bg-indigo-600 text-white p-3 md:p-4 rounded-2xl shadow-xl hover:bg-indigo-700 active:scale-90 disabled:opacity-50 shrink-0 transition-all mb-1"><Send size={20} /></button>
              </form>
            </footer>
          </>
        ) : (
          <div className="flex-1 flex flex-col items-center justify-center text-slate-300 p-8 text-center uppercase tracking-[0.25em] font-black">
            <div className="bg-slate-50 p-10 rounded-[3rem] border border-slate-100 mb-8"><MessageSquare size={64} className="opacity-10" /></div>
            <p className="text-[10px]">Secure Vault established</p>
          </div>
        )}
      </div>
    </div>
  );
}
